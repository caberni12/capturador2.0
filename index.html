<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Capturador de Datos ‚Äì PRO DEFINITIVO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f1f5f9;color:#0f172a}
.wrap{max-width:480px;margin:auto;padding:14px}
.card{background:#fff;border-radius:20px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
h2{text-align:center;margin:0 0 10px;font-size:18px}

input,button{
 width:100%;
 padding:14px;
 margin-top:10px;
 border-radius:14px;
 border:1px solid #e2e8f0;
 font-size:15px
}
button{border:none;font-weight:700}
.primary{background:#0ea5e9;color:#fff}
.secondary{background:#64748b;color:#fff}
.danger{background:#ef4444;color:#fff}
.success{background:#22c55e;color:#fff}
.qrbtn{width:64px;background:#22c55e;color:#fff;font-size:22px}

.field{display:flex;gap:8px}
.field input{flex:1}

#scannerBox{
 display:none;
 position:relative;
 margin-top:12px;
 border-radius:18px;
 overflow:hidden;
 background:#000
}
.scan-frame{
 position:absolute;
 inset:0;
 border:2px solid rgba(239,68,68,.7)
}
.scan-line{
 position:absolute;
 left:0;right:0;
 height:2px;
 background:red;
 animation:scan 2s linear infinite
}
@keyframes scan{
 0%{top:0}
 50%{top:95%}
 100%{top:0}
}

.scanner-controls{
 position:absolute;
 bottom:10px;
 left:10px;
 right:10px;
 display:flex;
 gap:10px
}
.ctrl{
 flex:1;
 border-radius:12px;
 padding:10px;
 font-size:14px
}

.table{margin-top:14px}
.row{
 background:#f8fafc;
 padding:10px;
 border-radius:12px;
 margin-top:6px
}
.small{font-size:12px;color:#475569}
</style>
</head>

<body>

<audio id="beep">
 <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg">
</audio>

<div class="wrap">
 <div class="card">
  <h2>üìã Capturador PRO</h2>

  <input id="operador" placeholder="Nombre del operador">

  <div class="field">
   <input id="ubicacion" placeholder="Ubicaci√≥n">
   <button class="qrbtn" onclick="scanUbicacion()">üìç</button>
  </div>

  <div class="field">
   <input id="codigo" placeholder="C√≥digo" oninput="buscarDescripcion()">
   <button class="qrbtn" onclick="scanCodigo()">üì∑</button>
  </div>

  <input id="descripcion" placeholder="Descripci√≥n">
  <input id="cantidad" type="number" value="1">

  <button class="secondary" onclick="toggleScanner()">üëÅ Mostrar / Ocultar Scanner</button>

  <div id="scannerBox">
   <div class="scan-frame"></div>
   <div class="scan-line"></div>
   <div class="scanner-controls">
    <button class="ctrl success" onclick="toggleTorch()">üî¶ Linterna</button>
    <button class="ctrl danger" onclick="cerrarScanner()">‚ùå Cerrar</button>
   </div>
  </div>

  <button class="secondary" onclick="ingresar()">‚ûï Ingresar</button>

  <div class="table" id="tabla"></div>

  <button class="success" onclick="exportarExcel()">üìä Exportar Excel</button>
  <button class="primary" onclick="exportarPDF()">üìÑ Exportar PDF</button>
  <button class="danger" onclick="finalizar()">‚ùå Finalizar proceso</button>
 </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwOx6mRhIPWQLXXeH5s_Fsw3A6A_dZv-ATUxQpybSR5jsoaH34i8c62eIhipmNy--ug/exec";

let productos=[];
let capturas=JSON.parse(localStorage.getItem("capturas")||"[]");
let scanner=null,modo=null,torch=false;

ubicacion.value=localStorage.getItem("ubicacion")||"";
operador.value=localStorage.getItem("operador")||"";

/* CARGAR PRODUCTOS */
fetch(API)
 .then(r=>r.json())
 .then(d=>{
  productos=d;
  localStorage.setItem("productos",JSON.stringify(d));
 })
 .catch(()=>{
  const ls=localStorage.getItem("productos");
  if(ls) productos=JSON.parse(ls);
 });

render();

/* BUSCAR DESCRIPCI√ìN */
function buscarDescripcion(){
 const c=codigo.value.trim().toLowerCase();
 if(!c){descripcion.value="";return;}
 const p=productos.find(x=>String(x.CODIGO).toLowerCase()===c);
 if(p) descripcion.value=p.DESCRIPCION||"";
}

/* SCANNER */
function scanCodigo(){modo="codigo";abrirScanner();}
function scanUbicacion(){modo="ubicacion";abrirScanner();}

function toggleScanner(){
 scannerBox.style.display==="none"?abrirScanner():cerrarScanner();
}

function abrirScanner(){
 if(scanner) return;
 scannerBox.style.display="block";
 scanner=new Html5Qrcode("scannerBox");
 scanner.start({facingMode:"environment"},{fps:12,qrbox:260},txt=>{
  beep.play();
  navigator.vibrate?.(200);
  if(modo==="codigo"){codigo.value=txt;buscarDescripcion();}
  if(modo==="ubicacion"){
   ubicacion.value=txt;
   localStorage.setItem("ubicacion",txt);
  }
  cerrarScanner();
 });
}

function cerrarScanner(){
 if(!scanner) return;
 scanner.stop().then(()=>{
  scanner.clear();
  scanner=null;
  scannerBox.style.display="none";
 });
}

function toggleTorch(){
 torch=!torch;
 scanner?.applyVideoConstraints({advanced:[{torch:torch}]}).catch(()=>{});
}

/* INGRESAR */
function ingresar(){
 localStorage.setItem("ubicacion",ubicacion.value);
 localStorage.setItem("operador",operador.value);

 capturas.push({
  Fecha:new Date().toLocaleString(),
  Operador:operador.value,
  Ubicaci√≥n:ubicacion.value,
  C√≥digo:codigo.value,
  Descripci√≥n:descripcion.value,
  Cantidad:cantidad.value
 });

 localStorage.setItem("capturas",JSON.stringify(capturas));
 render();
}

/* LISTA */
function render(){
 tabla.innerHTML="";
 capturas.forEach(c=>{
  tabla.innerHTML+=`
   <div class="row">
    <b>${c.C√≥digo}</b> ‚Äì ${c.Descripci√≥n}<br>
    <span class="small">${c.Ubicaci√≥n} | ${c.Operador} | ${c.Fecha} | Cant: ${c.Cantidad}</span>
   </div>`;
 });
}

/* EXPORTES */
function exportarExcel(){
 if(!capturas.length){alert("No hay datos");return;}
 const ws=XLSX.utils.json_to_sheet(capturas);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Captura");
 XLSX.writeFile(wb,"captura_pro.xlsx");
}

function exportarPDF(){
 if(!capturas.length){alert("No hay datos");return;}
 const w=window.open("");
 let html="<h3>Reporte de Captura</h3><table border='1' cellpadding='5'><tr>";
 Object.keys(capturas[0]).forEach(k=>html+="<th>"+k+"</th>");
 html+="</tr>";
 capturas.forEach(r=>{
  html+="<tr>";
  Object.values(r).forEach(v=>html+="<td>"+v+"</td>");
  html+="</tr>";
 });
 html+="</table>";
 w.document.write(html);
 w.print();
}

/* FINALIZAR */
function finalizar(){
 if(!capturas.length){alert("No hay datos");return;}
 exportarExcel();
 setTimeout(()=>{
  capturas=[];
  localStorage.clear();
  location.reload();
 },1000);
}
</script>

</body>
</html>

